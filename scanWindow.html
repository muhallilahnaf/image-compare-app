<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./index.css">
</head>

<body>
    <section id="scan-container">
        <p id="scan-info">
            Add the root folders to scan.
            It will scan through all the images inside the folders.
        </p>
        <form id="form-dir">
            <div class="directory">
                <button class="add-dir add-1">Add Folder</button><input type="text" class="dir-name name-1" readonly>
            </div>
            <button id="plus">+</button>
        </form>
        <button id="scan">Scan</button>
    </section>
</body>

<script>
    const form = document.getElementById('form-dir')
    const plus = document.getElementById('plus')
    const scan = document.getElementById('scan')
    let intervalId

    document.getElementsByClassName('add-dir')[0].addEventListener('click', (e) => {
        e.preventDefault()

        // get target input element
        const targetNo = /\d/.exec(e.target.className)

        // send info to main
        window.api.send('scan:add', targetNo)
    })

    plus.addEventListener('click', (e) => {
        e.preventDefault()

        const div = document.createElement('div')
        div.className = 'directory'

        const len = document.getElementsByClassName('add-dir').length

        const button = document.createElement('button')
        button.className = `add-dir add-${len + 1}`
        button.innerHTML = 'Add Folder'
        button.addEventListener('click', (e) => {
            e.preventDefault()

            // get target input element
            const targetNo = /\d/.exec(e.target.className)

            // send info to main
            window.api.send('scan:add', targetNo)
        })

        const input = document.createElement('input')
        input.setAttribute('type', 'text')
        input.setAttribute('readonly', 'true')
        input.className = `dir-name name-${len + 1}`

        div.appendChild(button)
        div.appendChild(input)

        form.insertBefore(div, form.lastElementChild)

        if (len + 1 === 5) plus.style.display = 'none'
    })

    scan.addEventListener('click', (e) => {
        const elements = document.getElementsByClassName('dir-name')
        let dirs = []

        for (const ele of elements) {
            dirs.push(ele.value)
        }

        window.api.send('scan:start', dirs)
        scan.setAttribute('disabled', 'true')
        let i = 1
        intervalId = setInterval(() => {
            scan.innerHTML = `Scanning${'.'.repeat(i)}`
            i === 3 ? i = 1 : i++
        }, 500);
    })

    // receive info from main for scan:add
    window.api.receive('scan:add', (data) => {
        document.querySelector(`.name-${data.number}`).value = data.dir
    })

    // receive info from main for scan:finish
    window.api.receive('scan:finish', (data) => {
        clearInterval(intervalId)
        scan.removeAttribute('disabled')
        scan.innerHTML = 'Scan'
    })

</script>

</html>
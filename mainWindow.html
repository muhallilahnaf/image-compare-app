<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./index.css">
</head>

<body>
    <section id="container">
        <section id="sidebar"></section>
        <section id="main">
            <div id="picdiv">
                <div id="pic"></div>
                <div id="picname"></div>
                <button id="delete">delete</button>
            </div>
        </section>
    </section>
    <script>
        'use strict'

        const sidebar = document.getElementById('sidebar')
        const pic = document.getElementById('pic')
        const picname = document.getElementById('picname')
        const deleteButton = document.getElementById('delete')

        let matches = null
        let currentIndex = null
        let currentUrl = null
        let currentFileUrl = null

        // clear sidebar
        const clearSidebar = () => {
            while (sidebar.firstChild) {
                sidebar.firstChild.remove()
            }
        }

        // load pic and filename in box
        const loadPic = () => {
            if (currentFileUrl !== null) {
                pic.style.background = `url('${currentFileUrl}')`
                pic.style.backgroundRepeat = 'no-repeat'
                pic.style.backgroundSize = 'contain'
                picname.innerHTML = currentUrl
            } else {
                pic.style.background = 'none'
                picname.innerHTML = ''
            }
        }

        // reset current values
        const resetCurrent = () => {
            currentUrl = null
            currentFileUrl = null
            currentIndex = null
        }

        // set current values
        const setCurrent = (node) => {
            currentFileUrl = node.matchesFileURL
            currentUrl = node.matchesPath
            currentIndex = node.matchesIndex
        }

        // remove url node from sidebar
        const removeUrlNode = (url) => {
            const targetParent = document.querySelector(`.match-${currentIndex}`)
            const targetUrls = targetParent.querySelectorAll('.url')

            for (const node of targetUrls) {
                if (node.matchesPath === url) node.remove()
            }
        }

        // load matches data in sidebar
        const loadSidebar = (m) => {
            // update matches variable and clear sidebar
            matches = m
            clearSidebar()

            // populate sidebar and add listener on urls
            m.forEach((match, i) => {
                console.log(match)
                const div = document.createElement('div')
                div.className = `match match-${i}`
                div.matchesIndex = i

                const p = document.createElement('p')
                p.className = 'basename'
                p.innerHTML = match.basename
                div.appendChild(p)

                match.urls.forEach(urlItem => {
                    const pInner = document.createElement('p')
                    pInner.className = 'url'
                    pInner.innerHTML = urlItem.path
                    pInner.matchesIndex = i
                    pInner.matchesPath = urlItem.path
                    pInner.matchesFileURL = urlItem.fileURL

                    pInner.addEventListener('click', e => {
                        // reset current values and pic background
                        resetCurrent()
                        loadPic()

                        console.log(e.currentTarget)
                        // set current variable and load pic
                        setCurrent(e.currentTarget)
                        loadPic()
                    })
                    div.appendChild(pInner)
                })

                sidebar.appendChild(div)
            })
        }

        // main:load
        window.api.receive('main:load', (matchs) => {
            console.log('main:load')
            loadSidebar(matchs)
            console.log('load done')
        })

        // main:delete
        deleteButton.addEventListener('click', () => {
            if (currentUrl !== null) {
                window.api.send('main:delete', { currentUrl, currentIndex })
            }
        })

        // main:deleted
        window.api.receive('main:deleted', obj => {
            // change matches array
            matches = obj.state.data

            // update sidebar
            removeUrlNode(obj.url)

            // reset current values and pic background
            resetCurrent()
            loadPic()
        })

        // document.addEventListener('drop', (e) => {
        //     e.preventDefault();
        //     e.stopPropagation();

        //     for (const f of e.dataTransfer.files) {
        //         console.log('File(s) you dragged here: ', f.path)
        //     }
        // });
        // document.addEventListener('dragover', (e) => {
        //     e.preventDefault();
        //     e.stopPropagation();
        // });
    </script>
    <!-- <script src="./fs-helpers.js"></script>
    <script src="./index.js"></script> -->
</body>

</html>